/**
 * PROGRESSION ENGINE - Moteur de calculs de progression
 * Module pour calculer la progression des exercices
 * 
 * @module core/progression-engine
 * @version 1.0.0
 */

export class ProgressionEngine {
  constructor(programData) {
    this.programData = programData;
    this.userWeights = this.loadUserWeights();
  }

  /**
   * Calcule le poids pour un exercice à une semaine donnée
   * @param {Object} exercise - Exercice de base
   * @param {number} weekNumber - Numéro de semaine
   * @returns {number} Poids calculé
   */
  calculateWeight(exercise, weekNumber) {
    // Vérifier si l'utilisateur a modifié le poids
    const userWeight = this.getUserWeight(exercise.id, weekNumber);
    if (userWeight !== null) {
      return userWeight;
    }

    // Sinon, utiliser le poids du programme
    return exercise.weight;
  }

  /**
   * Calcule la progression d'un exercice sur toutes les semaines
   * @param {string} exerciseName - Nom de l'exercice
   * @returns {Array} Tableau de progression
   */
  getExerciseProgression(exerciseName) {
    const progression = [];

    for (let week = 1; week <= 26; week++) {
      const weekData = this.programData.getWeek(week);
      
      // Chercher l'exercice dans tous les jours
      ['dimanche', 'mardi', 'vendredi', 'maison'].forEach(day => {
        const workout = weekData[day];
        const exercise = workout.exercises.find(ex => ex.name === exerciseName);

        if (exercise) {
          const weight = this.calculateWeight(exercise, week);
          
          progression.push({
            week,
            day,
            weight,
            sets: exercise.sets,
            reps: exercise.reps,
            volume: this.calculateExerciseVolume(exercise, weight),
            technique: weekData.technique,
            isDeload: weekData.isDeload
          });
        }
      });
    }

    return progression;
  }

  /**
   * Calcule le volume d'un exercice (poids × reps × sets)
   * @param {Object} exercise - Exercice
   * @param {number} weight - Poids utilisé
   * @returns {number} Volume en kg
   */
  calculateExerciseVolume(exercise, weight) {
    // Gérer les reps sous forme de range (ex: "6-8")
    const reps = typeof exercise.reps === 'string' 
      ? parseInt(exercise.reps.split('-')[0]) 
      : exercise.reps;

    return Math.round(weight * reps * exercise.sets);
  }

  /**
   * Calcule le volume total d'une séance
   * @param {number} weekNumber - Numéro de semaine
   * @param {string} day - Jour de la séance
   * @returns {Object} Détails du volume
   */
  calculateWorkoutVolume(weekNumber, day) {
    const workout = this.programData.getWorkout(weekNumber, day);
    
    let totalVolume = 0;
    let totalSets = 0;
    let totalReps = 0;

    workout.exercises.forEach(exercise => {
      const weight = this.calculateWeight(exercise, weekNumber);
      const volume = this.calculateExerciseVolume(exercise, weight);

      totalVolume += volume;
      totalSets += exercise.sets;

      const reps = typeof exercise.reps === 'string'
        ? parseInt(exercise.reps.split('-')[0])
        : exercise.reps;
      totalReps += exercise.sets * reps;
    });

    return {
      totalVolume,
      totalSets,
      totalReps,
      averageWeight: Math.round(totalVolume / totalReps)
    };
  }

  /**
   * Calcule le volume total d'une semaine
   * @param {number} weekNumber - Numéro de semaine
   * @returns {Object} Détails du volume hebdomadaire
   */
  calculateWeekVolume(weekNumber) {
    const days = ['dimanche', 'mardi', 'vendredi', 'maison'];
    let totalVolume = 0;
    let totalSets = 0;
    let totalReps = 0;

    const byDay = {};

    days.forEach(day => {
      const dayVolume = this.calculateWorkoutVolume(weekNumber, day);
      byDay[day] = dayVolume;

      totalVolume += dayVolume.totalVolume;
      totalSets += dayVolume.totalSets;
      totalReps += dayVolume.totalReps;
    });

    return {
      weekNumber,
      totalVolume,
      totalSets,
      totalReps,
      averageWeight: Math.round(totalVolume / totalReps),
      byDay
    };
  }

  /**
   * Calcule le volume par groupe musculaire pour une semaine
   * @param {number} weekNumber - Numéro de semaine
   * @returns {Object} Volume par muscle
   */
  calculateVolumeByMuscle(weekNumber) {
    const weekData = this.programData.getWeek(weekNumber);
    const muscleVolume = {};

    ['dimanche', 'mardi', 'vendredi', 'maison'].forEach(day => {
      const workout = weekData[day];

      workout.exercises.forEach(exercise => {
        const weight = this.calculateWeight(exercise, weekNumber);
        const volume = this.calculateExerciseVolume(exercise, weight);

        // Distribuer le volume sur tous les muscles travaillés
        if (exercise.muscle && Array.isArray(exercise.muscle)) {
          exercise.muscle.forEach(muscle => {
            if (!muscleVolume[muscle]) {
              muscleVolume[muscle] = {
                direct: 0,
                indirect: 0,
                total: 0,
                sets: 0
              };
            }

            // Le premier muscle est considéré comme direct
            if (exercise.muscle.indexOf(muscle) === 0) {
              muscleVolume[muscle].direct += volume;
              muscleVolume[muscle].sets += exercise.sets;
            } else {
              muscleVolume[muscle].indirect += volume * 0.6; // Facteur indirect
            }

            muscleVolume[muscle].total = 
              muscleVolume[muscle].direct + muscleVolume[muscle].indirect;
          });
        }
      });
    });

    return muscleVolume;
  }

  /**
   * Suggère une progression pour un exercice
   * @param {string} exerciseId - ID de l'exercice
   * @param {number} currentWeek - Semaine actuelle
   * @param {number} currentWeight - Poids actuel
   * @param {number} rpe - RPE ressenti (1-10)
   * @returns {Object} Suggestion de progression
   */
  suggestProgression(exerciseId, currentWeek, currentWeight, rpe) {
    const nextWeek = currentWeek + 1;

    if (nextWeek > 26) {
      return {
        suggestion: 'Programme terminé',
        newWeight: currentWeight,
        reason: 'Fin des 26 semaines'
      };
    }

    // Si deload, réduire de 40%
    if ([6, 12, 18, 24, 26].includes(nextWeek)) {
      return {
        suggestion: 'Deload',
        newWeight: Math.round(currentWeight * 0.6 * 2) / 2,
        reason: 'Semaine de récupération programmée'
      };
    }

    // Suggestion basée sur le RPE
    if (rpe <= 6) {
      return {
        suggestion: 'Augmenter',
        newWeight: currentWeight + 2.5,
        reason: 'RPE faible, augmentation possible'
      };
    } else if (rpe >= 9) {
      return {
        suggestion: 'Réduire',
        newWeight: Math.max(currentWeight - 2.5, currentWeight * 0.9),
        reason: 'RPE trop élevé, réduire pour éviter surentraînement'
      };
    } else {
      return {
        suggestion: 'Maintenir',
        newWeight: currentWeight,
        reason: 'Progression optimale'
      };
    }
  }

  /**
   * Calcule les statistiques de progression sur plusieurs semaines
   * @param {number} startWeek - Semaine de début
   * @param {number} endWeek - Semaine de fin
   * @returns {Object} Statistiques
   */
  calculateProgressionStats(startWeek, endWeek) {
    const startVolume = this.calculateWeekVolume(startWeek);
    const endVolume = this.calculateWeekVolume(endWeek);

    const volumeIncrease = endVolume.totalVolume - startVolume.totalVolume;
    const volumeIncreasePercent = Math.round(
      (volumeIncrease / startVolume.totalVolume) * 100
    );

    const averageWeightIncrease = endVolume.averageWeight - startVolume.averageWeight;
    const averageWeightIncreasePercent = Math.round(
      (averageWeightIncrease / startVolume.averageWeight) * 100
    );

    return {
      period: `Semaine ${startWeek} → ${endWeek}`,
      volumeIncrease,
      volumeIncreasePercent,
      averageWeightIncrease,
      averageWeightIncreasePercent,
      startVolume: startVolume.totalVolume,
      endVolume: endVolume.totalVolume,
      startAverageWeight: startVolume.averageWeight,
      endAverageWeight: endVolume.averageWeight
    };
  }

  /**
   * Sauvegarde un poids modifié par l'utilisateur
   * @param {string} exerciseId - ID de l'exercice
   * @param {number} weekNumber - Numéro de semaine
   * @param {number} weight - Nouveau poids
   */
  saveUserWeight(exerciseId, weekNumber, weight) {
    const key = `${exerciseId}_w${weekNumber}`;
    this.userWeights[key] = weight;
    this.persistUserWeights();
  }

  /**
   * Récupère un poids modifié par l'utilisateur
   * @param {string} exerciseId - ID de l'exercice
   * @param {number} weekNumber - Numéro de semaine
   * @returns {number|null} Poids ou null
   */
  getUserWeight(exerciseId, weekNumber) {
    const key = `${exerciseId}_w${weekNumber}`;
    return this.userWeights[key] || null;
  }

  /**
   * Charge les poids modifiés depuis localStorage
   * @returns {Object} Poids utilisateur
   */
  loadUserWeights() {
    try {
      const saved = localStorage.getItem('hybrid_master_user_weights');
      return saved ? JSON.parse(saved) : {};
    } catch (error) {
      console.error('Error loading user weights:', error);
      return {};
    }
  }

  /**
   * Sauvegarde les poids modifiés dans localStorage
   */
  persistUserWeights() {
    try {
      localStorage.setItem(
        'hybrid_master_user_weights',
        JSON.stringify(this.userWeights)
      );
    } catch (error) {
      console.error('Error saving user weights:', error);
    }
  }

  /**
   * Réinitialise tous les poids modifiés
   */
  resetUserWeights() {
    this.userWeights = {};
    localStorage.removeItem('hybrid_master_user_weights');
  }

  /**
   * Calcule le 1RM estimé pour un exercice
   * @param {number} weight - Poids utilisé
   * @param {number} reps - Répétitions effectuées
   * @returns {number} 1RM estimé (formule d'Epley)
   */
  estimate1RM(weight, reps) {
    if (reps === 1) return weight;
    // Formule d'Epley : 1RM = weight × (1 + reps/30)
    return Math.round(weight * (1 + reps / 30));
  }

  /**
   * Calcule le pourcentage de progression entre deux semaines
   * @param {number} week1 - Première semaine
   * @param {number} week2 - Deuxième semaine
   * @returns {number} Pourcentage de progression
   */
  calculateProgressionPercentage(week1, week2) {
    const vol1 = this.calculateWeekVolume(week1);
    const vol2 = this.calculateWeekVolume(week2);

    if (vol1.totalVolume === 0) return 0;

    return Math.round(
      ((vol2.totalVolume - vol1.totalVolume) / vol1.totalVolume) * 100
    );
  }
}
